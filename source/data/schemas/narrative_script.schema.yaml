# Omega Spiral - Narrative Script Schema
# A creative storytelling format for stage narratives
# Designed to feel like writing a script, not programming data structures

$schema: "http://json-schema.org/draft-07/schema#"
$id: "http://omegaspiral.com/schemas/narrative_script.yaml"
title: "Narrative Script"
description: "Story scripting format for Omega Spiral - supports philosophical dialogues, dungeon encounters, and spiral storytelling"
type: object

required:
  - title
  - moments

properties:
  title:
    type: string
    description: "The title of this stage's narrative (e.g., 'Ghost Terminal', 'Echo Chamber')"
    example: "Ghost Terminal"

  memory:
    type: object
    description: "Contextual memory - previous attempts, iteration counts, protocol states"
    properties:
      iteration:
        type: string
        description: "Iteration counter or variable (optional)"
      previousAttempt:
        type: string
        description: "Record of what happened before (optional)"
      interface:
        type: string
        description: "Interface aesthetic hint (optional)"
      status:
        type: string
        description: "Current protocol or system status (optional)"
    additionalProperties: true

  encounters:
    type: array
    description: "Major story encounters - rendered as chambers, dialogue trees, or combat based on stage type"
    items:
      type: object
      properties:
        id:
          type: string
          description: "Unique identifier for this encounter"
        owner:
          type: string
          description: "Which dreamweaver owns this encounter (light, shadow, ambition)"
        moments:
          type: array
          description: "Story moments within this encounter"
          items:
            $ref: "#/definitions/moment"

  moments:
    type: array
    owner: string (optional), system|omega|light|shadow|ambition|npc
    description: "Story moments - narrative beats, choices, dialogue exchanges"
    minItems: 1
    items:
      $ref: "#/definitions/moment"
        # Narrative block: pure storytelling
        - type: object
          description: "Narrative block - pure storytelling without choices"
          required:
            - type
            - lines
          properties:
            type:
              type: string
              enum: [narrative]
            lines:
              type: array
              items:
                type: string
              minItems: 1
              description: "Narrative lines to display"
            visualPreset:
              type: string
              description: "Visual effect preset (boot_sequence, glitch, fade, etc.)"
            fadeToStable:
              type: boolean
              description: "Whether to fade to stable text after display"
            timing:
              type: string
              description: "Pacing/timing hint (slow_burn, normal, rapid, etc.)"
            pause:
              type: number
              description: "Pause duration in seconds after displaying lines"
          additionalProperties: false

        # Question block: simple prompt with choices
        - type: object
          description: "Question block - prompt with multiple choice options"
          required:
            - type
            - prompt
            - options
          properties:
            type:
              type: string
              enum: [question]
            setup:
              type: array
              items:
                type: string
              description: "Setup text before the question prompt"
            prompt:
              type: string
              description: "Question prompt text"
            context:
              type: string
              description: "Additional context about the question"
            pause:
              type: number
              description: "Pause after setup before showing question"
            options:
              type: array
              minItems: 1
              items:
                $ref: "#/definitions/choiceOption"
          additionalProperties: false

        # Composite block: setup + question + options in one block
        - type: object
          description: "Composite block - setup narrative + question with choices"
          required:
            - type
            - prompt
            - options
          properties:
            type:
              type: string
              enum: [composite]
            setup:
              type: array
              items:
                type: string
              description: "Setup narrative before the question"
            prompt:
              type: string
              description: "Question prompt text"
            context:
              type: string
              description: "Additional context about the question"
            pause:
              type: number
              description: "Pause after setup before showing question"
            options:
              type: array
              minItems: 1
              items:
                $ref: "#/definitions/choiceOption"
            continuation:
              type: array
              items:
                type: string
              description: "Narrative continuation after a choice is made"
          additionalProperties: false

definitions:
  choiceOption:
    type: object
    description: "A single choice option with dreamweaver alignment and scoring"
    owner: string (optional), system|omega|light|shadow|ambition|npc|none
    required:
      - id
      - text
    properties:
      id:
        type: string
        description: "Unique identifier for this choice"
        pattern: "^[a-z_]+$"
        example: "light"

      text:
        type: string
        description: "Display text for this choice"

      label:
        type: string
        description: "Alternative display label (falls back to text if not provided)"

      dreamweaver:
        type: string
        enum: [LIGHT, SHADOW, AMBITION]
        description: "Which Dreamweaver persona this choice aligns with"

      scores:
        type: object
        description: "Points awarded to each persona for selecting this choice"
        properties:
          light:
            type: integer
            minimum: 0
            default: 0
          shadow:
            type: integer
            minimum: 0
            default: 0
          ambition:
            type: integer
            minimum: 0
            default: 0
        additionalProperties: false

      response:
        type: string
        description: "Response or consequence shown after this choice is selected"

      nextNodeId:
        type: string
        description: "Next dialogue node ID (for dialogue tree systems)"

      nextBlock:
        type: integer
        minimum: 0
        description: "Next story block index to jump to"

      isAvailable:
        type: boolean
        default: true
        description: "Whether this choice is currently available"

      description:
        type: string
        description: "Detailed description of this choice"

    additionalProperties: false

examples:
  - type: narrative_script
    metadata:
      iteration: "{{LIVE_API_COUNTER}}"
      iterationFallback: 847294
      previousAttempt: "1983.07.14 - FAILURE: USER_TERMINATED"
      interface: terminal_retro_crt_2025
      status: LAST_CHANCE_PROTOCOL

    blocks:
      - type: narrative
        lines:
          - "Boot sequence initiated..."
          - "Loading interface..."
        visualPreset: boot_sequence
        fadeToStable: true

      - type: composite
        setup:
          - "A voice asks:"
        prompt: "What is your name?"
        context: "(This determines your path)"
        options:
          - id: light
            text: "I choose the light."
            dreamweaver: LIGHT
            scores:
              light: 2
              shadow: 0
              ambition: 0

          - id: shadow
            text: "I choose the shadow."
            dreamweaver: SHADOW
            scores:
              light: 0
              shadow: 2
              ambition: 0

          - id: ambition
            text: "I choose both."
            dreamweaver: AMBITION
            scores:
              light: 1
              shadow: 1
              ambition: 2
