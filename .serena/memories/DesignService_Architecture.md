# Design Service Architecture

## Overview
The **design subsystem** provides a centralized way to load UI colors and shader presets from a JSON configuration file (`omega_spiral_colors_config.json`).

### Key Types
- **`OmegaSpiralConfig`** – Root object deserialized from the JSON file. Contains two dictionaries:
  - `DesignSystem` → `Dictionary<string, ColorValue>`
  - `ShaderPresets` → `Dictionary<string, ShaderPreset>`
- **`ColorValue`** – Represents a color with RGBA components and optional metadata (`Doc`, `Hex`, `AlphaNote`).
- **`ShaderPreset`** – Holds a shader path and a dictionary of parameters (`IReadOnlyDictionary<string, object>`).
- **`ColorsConfig`** – Internal aggregation used by `DesignService` to expose the two dictionaries after loading.

### `DesignService` (static)
- **`_ConfigPath`** – Resource path to the JSON file.
- **`_Config`** – `Lazy<ColorsConfig>` that loads the configuration once, thread‑safe.
- **`GetColor(string name)`** – Returns a `Godot.Color` from the palette, falling back to `Colors.White` and emitting a warning if missing.
- **`TryGetShaderPreset(string presetKey, out ShaderPreset? preset)`** – Retrieves a full `ShaderPreset` object.
- **`TryGetShaderDefaults(string presetKey, out IReadOnlyDictionary<string, object> parameters)`** – Retrieves only the parameter map for a preset.
- **`LoadConfig()`** – Reads the JSON file, deserializes to `OmegaSpiralConfig`, builds a `ColorsConfig`, ensures required palette entries exist, and logs errors/warnings.
- **`EnsureRequiredColors(ColorsConfig config)`** – Guarantees that a minimal set of palette colors (`warm_amber`, `pure_white`, `light_thread`, `shadow_thread`, `ambition_thread`) are always present.

### Usage Flow
1. **First call** to any public method triggers lazy loading.
2. `LoadConfig` reads the file via `FileAccess.GetFileAsString`.
3. JSON is deserialized with **Newtonsoft.Json** into `OmegaSpiralConfig`.
4. The resulting dictionaries are wrapped in `ColorsConfig`.
5. Required colors are injected if missing.
6. Consumers (UI components, e.g., `OmegaBorderFrame`, `OmegaUiButton`) request colors or shader defaults via the static methods.

## Interaction with Other Subsystems
- **UI Components** call `DesignService.GetColor` to style nodes.
- **Shader Setup** uses `TryGetShaderDefaults` to apply parameter maps to `ShaderMaterial` instances.
- **Testing** can mock the static class by replacing the JSON file or using a custom `ColorsConfig` via reflection (not recommended for production).

## Extensibility
- Add new palette entries to `omega_spiral_colors_config.json` under `design_system`.
- Add new shader presets under `shader_presets` with a `shader_path` and `parameters` map.
- Extend `ColorValue` with additional metadata if needed; ensure XML docs are added for any new members.

---
*Generated by the Serena memory system to capture the design service architecture for future reference.*
